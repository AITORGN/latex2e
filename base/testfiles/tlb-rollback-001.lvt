%
% Check that the rollback mechanism works
%
% A few test packages up front:
%
\begin{filecontents}{testpkg.sty}
% The current package ...
\providecommand\DeclareOldRelease[3][]{}
\providecommand\DeclareCurrentRelease[2][]{}
\DeclareOldRelease[v1]{2014-01-01}{testpkg-2014-01-01}
\DeclareOldRelease[v2]{2015-10-01}{testpkg-2015-10-01}
\DeclareCurrentRelease[v3]{2016-07-01}

\ProvidesPackage{testpkg}[2016-07-21 v3.5 test package] % this has a
                                                        % minor change
                                                        % so a
                                                        % different date
\DeclareOption{dvips}{\typeout{ -> option dvips executed}}
\ProcessOptions
\typeout{This is the current testpkg! }
% allow repeated loading (for testing)
\end{filecontents}

\begin{filecontents}{testpkg-2014-01-01.sty}
% the oldest known release (v1) ...
\providecommand\DeclareOldRelease[3][]{}
\providecommand\DeclareCurrentRelease[2][]{}
\DeclareCurrentRelease[v1]{2014-01-01}
\ProvidesPackage{testpkg}[2014-01-01 v1.2 test package]
\DeclareOption{dvips}{\typeout{ -> option dvips executed}}
\ProcessOptions
\typeout{This is testpkg 2014-01-01!}
% allow repeated loading (for testing)
\end{filecontents}

\begin{filecontents}{testpkg-2015-10-01.sty}
% this is v2 ...
\providecommand\DeclareOldRelease[3][]{}
\providecommand\DeclareCurrentRelease[2][]{}
\DeclareOldRelease[v1]{2014-01-01}{testpkg-2014-01-01}
\DeclareCurrentRelease[v2]{2015-10-01}
\ProvidesPackage{testpkg}[2015-10-01 v2.5 test package]
\DeclareOption{dvips}{\typeout{ -> option dvips executed}}
\ProcessOptions
\typeout{This is testpkg 2015-10-01!}
% allow repeated loading (for testing)
\end{filecontents}

% ======================================================


% Input the test macros for LaTeX2e
\input{test2e}

\makeatletter
\let\pkgcls@debug\typeout   % more output in the tests
\makeatother

\START

\documentclass{article}

\usepackage{alltt}               % a simple package load
\usepackage{ifthen}[2000/01/01]  % one with mindate
\usepackage{makeidx}[2050/01/01] % one with strange mindate

\def\ForgetAboutTestpkg{%
  \expandafter\let\csname ver@testpkg.sty\endcsname\relax
}

%%% TESTS %%%%

% no local rollback
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}

% mindate request
\ForgetAboutTestpkg
\RequirePackage[dvips]{testpkg}[2015/05/05]

% conflict with latexrelease later  on
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[2016-01-01]

% ... in future
\ForgetAboutTestpkg
\RequirePackage[dvips]{testpkg}[2020/05/05]

% earlier than the fist release!
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2011/03/01]

% earlier than the second release
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2014-03-01]

% exact
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2015-10-01]

% a few days off
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2015-10-02]

% kind of current
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2016-07-10]


% named request old
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=v2]

% name request current
\ForgetAboutTestpkg
\usepackage[]{testpkg}[=v3]

% ... does not exit
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=v4]


% now again with latexrelease set

\OMIT
\RequirePackage[2015-12-24]{latexrelease}
\TIMO

% no local rollback
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}

% mindate request
\ForgetAboutTestpkg
\RequirePackage[dvips]{testpkg}[2015/05/05]

% conflict with latexrelease later  on
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[2016-01-01]

% ... in future
\ForgetAboutTestpkg
\RequirePackage[dvips]{testpkg}[2020/05/05]

% earlier than the fist release!
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2011/03/01]

% earlier than the second release
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2014-03-01]

% exact
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2015-10-01]

% a few days off
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2015-10-02]

% kind of current
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=2016-07-10]


% named request old
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=v2]

% name request current
\ForgetAboutTestpkg
\usepackage[]{testpkg}[=v3]

% ... does not exit
\ForgetAboutTestpkg
\usepackage[dvips]{testpkg}[=v4]

\END

